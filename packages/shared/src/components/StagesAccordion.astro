---
import PortableText, { PortableTextQuery, type PortableTextValue } from '@repo/ui/portable-text'
import Image, { ImageDataQuery, type ImageDataProps } from '@repo/ui/Image'
import Button, { ButtonDataQuery, type ButtonDataProps } from '@repo/ui/Button'
import Accordion from '@repo/ui/Accordion.astro'

export const StagesAccordion_Query = `
  _type == "StagesAccordion" => {
    ${PortableTextQuery('heading')}
    imageMode,
    ${ImageDataQuery('img')}
    items[] {
      title,
      ${PortableTextQuery('content')}
      ${ButtonDataQuery('cta')}
      ${ImageDataQuery('openImg')}
    },
    annotation {
      ${ImageDataQuery('icon')}
      ${PortableTextQuery('text')}
    }
  },
`

type Props = {
  index: number
  sectionId?: string
  heading: PortableTextValue
  imageMode?: 'single' | 'multiple'
  img: ImageDataProps
  items: Array<{
    title: string
    content: PortableTextValue
    cta?: ButtonDataProps
    openImg?: ImageDataProps
  }>
  annotation?: {
    icon: ImageDataProps
    text: PortableTextValue
  }
}

const { index, sectionId, heading, imageMode, img, items, annotation } = Astro.props
const isMultipleImageMode = imageMode === 'multiple'
---

<section class='StagesAccordion' id={sectionId}>
  <header>
    <PortableText value={heading} heading={index === 0 ? 'h1' : 'h2'} class='heading h2' />
  </header>
  <div class='column'>
    <div>
      <div class='list'>
        {
          items.map(({ title, content, cta }) => (
            <Accordion summary={title}>
              <PortableText value={content} />
              {cta && <Button {...cta} className='cta' />}
            </Accordion>
          ))
        }
      </div>
      {
        annotation && (
          <div class='annotation'>
            <Image {...annotation.icon} sizes='20px' loading={index === 0 ? 'eager' : 'lazy'} />
            <PortableText value={annotation.text} />
          </div>
        )
      }
    </div>
    {
      isMultipleImageMode ? (
        <div class='img img-multiple' data-accordion-images>
          <div class='layer' data-image-layer data-active='true'>
            <Image
              {...img}
              sizes='(max-width: 48rem) 100vw, (max-width: 69rem) 38rem, 60vw'
              priority={index === 0}
            />
          </div>
          {items.map(({ openImg }, itemIndex) => (
            <div class='layer' data-image-layer data-item-index={itemIndex + 1} data-active='false'>
              <Image
                {...(openImg || img)}
                sizes='(max-width: 48rem) 100vw, (max-width: 69rem) 38rem, 60vw'
                loading='lazy'
              />
            </div>
          ))}
        </div>
      ) : (
        <Image
          {...img}
          sizes='(max-width: 48rem) 100vw, (max-width: 69rem) 38rem, 60vw'
          priority={index === 0}
          class='img'
        />
      )
    }
  </div>
</section>

<style lang='scss'>
  .StagesAccordion {
    padding: clamp(3rem, calc(5vw / 0.48), 6rem) 0;
    header {
      max-width: 34rem;
      margin-bottom: 3rem;
    }
    .column {
      display: grid;
      grid-template-columns: 1fr 1.75fr;
      gap: clamp(2rem, calc(3vw / 0.48), 8rem);
      .list {
        counter-reset: item;
        :global(details) {
          counter-increment: item;
          :global(summary) {
            padding-left: 0;
            padding-right: 0;
            grid-template-columns: 1fr clamp(1.5rem, calc(2vw / 0.48), 2rem);
            &::after {
              content: counter(item, decimal-leading-zero);
              margin-top: 0.31rem;
              color: var(--neutral-500, #75758a);
              font-size: var(--typography-body-s, 0.75rem);
            }
          }
          :global(.content) {
            color: var(--neutral-400, #c6cdcc);
            margin: 0;
          }
        }
        :global(.icon) {
          display: none;
        }
        .cta {
          margin-top: clamp(1rem, calc(2vw / 0.48), 2rem);
        }
      }
      .img {
        position: sticky;
        top: 5.25rem;
        border-radius: 0.25rem;
        border: 1px solid var(--neutral-800, #202025);
      }
      .img-multiple {
        position: sticky;
        top: 5.25rem;
        overflow: hidden;
        aspect-ratio: 16 / 10;
        .layer {
          position: absolute;
          inset: 0;
          opacity: 0;
          filter: blur(4px);
          transform: scale(1.03);
          transition: none;
          &[data-active='true'] {
            opacity: 1;
            filter: blur(0);
            transform: scale(1);
            transition:
              filter 500ms var(--easing),
              transform 500ms var(--easing),
              opacity 500ms var(--easing);
          }
          :global(img) {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
          }
        }
      }
    }
    .annotation {
      margin-top: clamp(3rem, calc(4vw / 0.48), 4rem);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: clamp(0.75rem, calc(1vw / 0.48), 1rem);
      color: var(--neutral-400, #c6cdcc);
      font-size: var(--typography-body-m, 0.875rem);
      img {
        width: 20px;
        height: 20px;
      }
    }
    @media (max-width: 69rem) {
      max-width: 38rem;
      margin: 0 auto;
      .column {
        grid-template-columns: 1fr;
        .img {
          position: static;
          order: -1;
        }
        .img-multiple {
          position: static;
          order: -1;
          .layer {
            position: relative;
            inset: auto;
            &:not([data-active='true']) {
              display: none;
            }
          }
        }
      }
    }
  }
</style>

<script>
  document.querySelectorAll<HTMLElement>('.StagesAccordion').forEach((section) => {
    const accordions = Array.from(section.querySelectorAll<HTMLDetailsElement>('.list details'))
    const imageLayers = Array.from(section.querySelectorAll<HTMLElement>('[data-image-layer]'))

    const setActiveImage = (activeIndex: number) => {
      if (imageLayers.length === 0) return
      imageLayers.forEach((layer, index) => {
        layer.setAttribute('data-active', index === activeIndex ? 'true' : 'false')
      })
    }

    const syncImage = () => {
      const openIndex = accordions.findIndex((acc) => acc.getAttribute('data-expanded') === 'true')
      setActiveImage(openIndex >= 0 ? openIndex + 1 : 0)
    }

    setActiveImage(0)

    let isClosingOthers = false

    accordions.forEach((details) => {
      const summary = details.querySelector('summary')
      summary?.addEventListener('click', () => {
        // Skip "close others" logic when this click was triggered
        // programmatically by another accordion's handler.
        if (isClosingOthers) return

        // Close any other open accordion (only-one-open behaviour)
        isClosingOthers = true
        accordions.forEach((otherDetails) => {
          if (details !== otherDetails && otherDetails.getAttribute('data-expanded') === 'true') {
            otherDetails.querySelector('summary')?.click()
          }
        })
        isClosingOthers = false

        // data-expanded is set synchronously by the Accordion component's
        // click handler; read it on the next frame to get the final state.
        requestAnimationFrame(syncImage)
      })
    })
  })
</script>
