---
import sanityFetch from '@repo/utils/sanity.fetch'
import Switch from '@repo/ui/Switch.astro'
import Button from '@repo/ui/Button'
import { DOMAIN } from '@repo/shared/constants'
import { type Language } from '@repo/shared/languages'

const lang = (Astro.params.lang as Language) || 'pl'

const { GA4_ID, META_PIXEL_ID, privacyPolicySlug } = await sanityFetch<{
  GA4_ID: string | null
  META_PIXEL_ID: string | null
  privacyPolicySlug: string
}>({
  query: `
    {
      "GA4_ID": *[_type == "analytics"][0].ga4_id,
      "META_PIXEL_ID": *[_type == "analytics"][0].meta_pixel_id,
      "privacyPolicySlug": *[_type == "PrivacyPolicy_Page" && language == $language][0].slug.current
    }
  `,
  params: { language: lang },
})
if (!GA4_ID && !META_PIXEL_ID) return null

const privacyPolicyUrl = `${DOMAIN}${privacyPolicySlug}`

const translations = {
  pl: {
    heading: 'Korzystając ze strony zgadzasz się na użycie ciasteczek',
    description:
      'Korzystamy z cookie i podobnych technologii, by analizować ruch na stronie, dopasować ją do Ciebie i wyświetlać trafniejsze reklamy.',
    learnMore: 'Dowiedz się więcej',
    settingsHeading: 'Ustawienia cookies',
    settingsDescription: 'Korzystając ze strony zgadzasz się na użycie tych ciasteczek.',
    necessary: {
      name: 'Niezbędne',
      description:
        'Te pliki cookie są konieczne do działania strony i nie mogą być wyłączone. Umożliwiają podstawowe funkcje, takie jak nawigacja, dostęp do zabezpieczonych obszarów oraz prawidłowe działanie formularzy. Są niezbędne do zapewnienia funkcjonalności i bezpieczeństwa strony zgodnie z wymogami RODO.',
    },
    analytics: {
      name: 'Analityczne',
      description:
        'Pomagają nam zrozumieć, jak korzystasz z naszej strony, zbierając anonimowe dane o interakcjach, czasie spędzonym na stronie i odwiedzanych podstronach. Dzięki nim możemy identyfikować problemy, ulepszać strukturę i zawartość witryny oraz optymalizować doświadczenie użytkownika. Dane są przetwarzane w formie zagregowanej i pseudonimizowanej.',
    },
    preferences: {
      name: 'Preferencyjne',
      description:
        'Zapamiętują Twoje indywidualne wybory i ustawienia (np. preferowany język, rozmiar czcionki, układ strony) podczas Twojej sesji oraz między wizytami, aby dostosować wygląd i działanie strony do Twoich potrzeb. Zwiększają wygodę korzystania z witryny, eliminując potrzebę ponownego wprowadzania tych samych informacji.',
    },
    marketing: {
      name: 'Marketingowe',
      description:
        'Służą do śledzenia Twoich aktywności na naszej stronie i innych witrynach, aby tworzyć profile zainteresowań i wyświetlać Ci bardziej trafne i spersonalizowane reklamy. Przetwarzanie tych danych odbywa się wyłącznie za Twoją zgodą, zgodnie z przepisami RODO, i może być w każdej chwili wycofane.',
      subGroups: {
        conversionApi: {
          name: 'API Konwersji',
          description:
            'Przesyła dane o Twoich działaniach bezpośrednio do platform reklamowych (takich jak Meta, LinkedIn, itp.), aby mierzyć skuteczność reklam zgodnie z RODO. Pozwala to na dokładniejsze śledzenie konwersji i optymalizację kampanii reklamowych.',
        },
        advancedMatching: {
          name: 'Zaawansowane Dopasowanie',
          description:
            'Umożliwia platformom reklamowym (takim jak Meta, LinkedIn, itp.) lepsze dopasowanie Twoich działań na stronie do Twojego profilu, co zwiększa trafność wyświetlanych reklam. Mechanizm ten działa w zgodzie z przepisami RODO, przetwarzając dane tylko za Twoją wyraźną zgodą.',
        },
      },
    },
    buttons: {
      deny: 'Odmowa',
      setPreferences: 'Ustaw preferencje',
      agreeAll: 'Zgoda na wszystkie',
    },
  },
  en: {
    heading: 'By using the website, you agree to the use of cookies',
    description:
      'We use cookies and similar technologies to analyze website traffic, tailor it to you, and display more relevant ads.',
    learnMore: 'Learn more',
    settingsHeading: 'Cookie settings',
    settingsDescription: 'By using the website, you agree to the use of these cookies.',
    necessary: {
      name: 'Necessary',
      description:
        'These cookies are essential for the website to function and cannot be disabled. They enable basic functions such as navigation, access to secure areas, and proper form functionality. They are necessary to ensure the functionality and security of the site in accordance with GDPR requirements.',
    },
    analytics: {
      name: 'Analytics',
      description:
        'Help us understand how you use our website by collecting anonymous data about interactions, time spent on the site, and visited pages. This allows us to identify problems, improve the structure and content of the website, and optimize the user experience. Data is processed in aggregated and pseudonymized form.',
    },
    preferences: {
      name: 'Preferences',
      description:
        'Remember your individual choices and settings (e.g., preferred language, font size, page layout) during your session and between visits to customize the appearance and operation of the site to your needs. They increase the convenience of using the website, eliminating the need to re-enter the same information.',
    },
    marketing: {
      name: 'Marketing',
      description:
        'Used to track your activities on our website and other sites to create interest profiles and show you more relevant and personalized ads. Processing of this data occurs only with your consent, in accordance with GDPR regulations, and can be withdrawn at any time.',
      subGroups: {
        conversionApi: {
          name: 'Conversion API',
          description:
            'Sends data about your actions directly to advertising platforms (such as Meta, LinkedIn, etc.) to measure ad effectiveness in accordance with GDPR. This allows for more accurate conversion tracking and advertising campaign optimization.',
        },
        advancedMatching: {
          name: 'Advanced Matching',
          description:
            'Enables advertising platforms (such as Meta, LinkedIn, etc.) to better match your on-site activities to your profile, increasing the relevance of displayed ads. This mechanism works in compliance with GDPR regulations, processing data only with your explicit consent.',
        },
      },
    },
    buttons: {
      deny: 'Deny',
      setPreferences: 'Set preferences',
      agreeAll: 'Accept all',
    },
  },
}
const t = translations[lang]

const groups = [
  {
    id: 'necessary',
    name: t.necessary.name,
    description: t.necessary.description,
  },
  {
    id: 'analytics',
    name: t.analytics.name,
    description: t.analytics.description,
  },
  {
    id: 'preferences',
    name: t.preferences.name,
    description: t.preferences.description,
  },
  {
    id: 'marketing',
    name: t.marketing.name,
    description: t.marketing.description,
    subGroups: [
      {
        id: 'conversion_api',
        name: t.marketing.subGroups.conversionApi.name,
        description: t.marketing.subGroups.conversionApi.description,
      },
      {
        id: 'advanced_matching',
        name: t.marketing.subGroups.advancedMatching.name,
        description: t.marketing.subGroups.advancedMatching.description,
      },
    ],
  },
]
---

{META_PIXEL_ID && (
  <noscript>
    <img
      height="1"
      width="1"
      style="display:none"
      src={`https://www.facebook.com/tr?id=${META_PIXEL_ID}&ev=PageView&noscript=1`}
      alt=""
    />
  </noscript>
)}
<aside class="cookie-consent" aria-hidden="true">
  <section class="content">
    <header class="header">
      <div data-header-initial>
        <h2 class="heading">{t.heading}</h2>
        <p class="description">
          {t.description}&nbsp;
          <a href={privacyPolicyUrl} target="_blank" rel="noopener" class="link">
            {t.learnMore}
          </a>
        </p>
      </div>
      <div data-header-settings style="display: none">
        <h3 class="heading">{t.settingsHeading}</h3>
        <p class="description">
          {t.settingsDescription}&nbsp;
          <a href={privacyPolicyUrl} target="_blank" rel="noopener" class="link">
            {t.learnMore}
          </a>
        </p>
      </div>
    </header>
    <div class="settings" style="display: none" data-lenis-prevent>
      {
        groups.map(({ id, name, description, subGroups }) => (
          <div class="group" data-group={id}>
            <label for={id} style={{ ...(id === 'necessary' && { cursor: 'not-allowed' }) }}>
              <Switch
                {...(id === 'necessary' && {
                  style: { cursor: 'not-allowed' },
                })}
                inputProps={{
                  id,
                  ...(id === 'necessary' && {
                    disabled: true,
                    checked: true,
                  }),
                }}
                class="switch"
              />
              <p>{name}</p>
              <p class="description">{description}</p>
            </label>
            {subGroups && (
              <div class="sub-groups">
                {subGroups.map((subGroup) => (
                  <label for={subGroup.id} class="sub-group">
                    <Switch
                      inputProps={{
                        id: subGroup.id,
                        'data-parent': id,
                      }}
                      class="switch"
                    />
                    <p>{subGroup.name}</p>
                    <p class="description">{subGroup.description}</p>
                  </label>
                ))}
              </div>
            )}
          </div>
        ))
      }
    </div>
    <div class="actions">
      <button class="deny">{t.buttons.deny}</button>
      <button class="setPreferences">{t.buttons.setPreferences}</button>
      <Button className="agree" theme="primary">{t.buttons.agreeAll}</Button>
    </div>
  </section>
</aside>

<style lang="scss">
  :global(html) {
    &:has(.cookie-consent[aria-hidden='false']) {
      overflow: hidden;
    }
  }
  $padding: clamp(1rem, calc(1.5vw / 0.48), 1.5rem);
  .cookie-consent {
    padding: $padding var(--page-margin);
    z-index: 11;
    position: fixed;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 1, 3, 0.5);
    backdrop-filter: blur(4px);
    display: grid;
    place-items: center;
    &[aria-hidden='true'] {
      display: none;
    }
  }
  .content {
    padding: $padding;
    max-height: calc(100vh - $padding * 2);
    max-height: calc(100dvh - $padding * 2);
    border-radius: 0.25rem;
    border: 1px solid var(--neutral-800, #202025);
    background: var(--neutral-900, #000103);
    max-width: 48rem;
    display: flex;
    flex-direction: column;
    gap: clamp(1.5rem, calc(2rem / 0.48), 2rem);
    .heading {
      font-size: var(--typography-body-xl, 1rem);
      margin-bottom: clamp(0.5rem, calc(1.25vw / 0.48), 1.25rem);
    }
    .description {
      font-size: var(--typography-body-m, 0.875rem);
    }
    .settings {
      display: flex;
      flex-direction: column;
      gap: clamp(0.75rem, calc(1.25vw / 0.48), 1.25rem);
      overflow-y: auto;
      overscroll-behavior: contain;
      .sub-groups {
        display: flex;
        flex-direction: column;
        padding-left: 1.5rem;
        padding-top: 1.5rem;
        gap: clamp(0.75rem, calc(1.25vw / 0.48), 1.25rem);
        position: relative;
        border-left: 1px solid var(--neutral-800, #202025);
      }
      label {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.25rem clamp(1rem, calc(1.5vw / 0.48), 1.5rem);
        font-size: var(--typography-body-m, 0.875rem);
        .switch {
          position: sticky;
          top: 0;
          grid-row: 1 / span 2;
        }
        .description {
          font-size: var(--typography-body-s, 0.75rem);
        }
      }
    }
  }
  .actions {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem 1.5rem;
    button {
      font-size: var(--typography-body-m, 0.875rem);
      min-height: 2.75rem;
      transition: color 300ms;
      &:hover {
        color: var(--neutral-400, #c6cdcc);
      }
      &:last-child {
        margin-left: auto;
      }
    }
    @media (max-width: 53rem) {
      button {
        flex-grow: 1;
        &:last-child {
          width: 100%;
        }
      }
    }
  }
</style>

<script is:inline define:vars={{ GA4_ID, META_PIXEL_ID }}>
  // Constants
  const COOKIE_NAME = 'cookie-consent'
  const CONSENT_ACCEPT_TTL_DAYS = 365
  const CONSENT_DENY_TTL_DAYS = 30 / (24 * 60) // 30 minutes

  const DENIED_CONSENT_MODE = {
    functionality_storage: 'denied',
    security_storage: 'denied',
    ad_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied',
    analytics_storage: 'denied',
    personalization_storage: 'denied',
    conversion_api: 'denied',
    advanced_matching: 'denied',
  }

  // State
  const loadedMetaPixels = new Set()
  let gtagScriptPromise = null
  let metaPixelScriptPromise = null
  const configuredGtagIds = new Set()

  // Utility functions
  function getCookie(name) {
    const cookies = document.cookie.split(';').map((cookie) => cookie.trim())
    const cookie = cookies.find((cookie) => cookie.startsWith(`${name}=`))
    return cookie ? decodeURIComponent(cookie.substring(name.length + 1)) : null
  }

  function setCookie(name, value, days = 1) {
    const date = new Date(Date.now() + 86400000 * days)
    const expires = days ? `; expires=${date.toUTCString()}` : ''
    document.cookie = `${name}=${encodeURIComponent(value)}${expires}; SameSite=Strict; path=/`
  }

  function setAnalyticsReady(ready) {
    window.__analyticsReady = ready
    if (ready) {
      document.dispatchEvent(new Event('analytics_ready'))
    }
  }

  function resolveConsentTtl(selection) {
    const hasOptionalConsent =
      selection.analytics ||
      selection.preferences ||
      selection.marketing ||
      selection.conversion_api ||
      selection.advanced_matching
    return hasOptionalConsent ? CONSENT_ACCEPT_TTL_DAYS : CONSENT_DENY_TTL_DAYS
  }

  function toConsentMode(selection) {
    return {
      functionality_storage: selection.necessary ? 'granted' : 'denied',
      security_storage: selection.necessary ? 'granted' : 'denied',
      ad_storage: selection.marketing ? 'granted' : 'denied',
      ad_user_data: selection.marketing ? 'granted' : 'denied',
      ad_personalization: selection.marketing ? 'granted' : 'denied',
      analytics_storage: selection.analytics ? 'granted' : 'denied',
      personalization_storage: selection.preferences ? 'granted' : 'denied',
      conversion_api: selection.conversion_api ? 'granted' : 'denied',
      advanced_matching: selection.advanced_matching ? 'granted' : 'denied',
    }
  }

  function selectionFromConsent(consent) {
    if (!consent) {
      return {
        necessary: true,
        analytics: false,
        preferences: false,
        marketing: false,
        conversion_api: false,
        advanced_matching: false,
      }
    }
    return {
      necessary: consent.functionality_storage === 'granted' && consent.security_storage === 'granted',
      analytics: consent.analytics_storage === 'granted',
      preferences: consent.personalization_storage === 'granted',
      marketing: consent.ad_storage === 'granted',
      conversion_api: consent.conversion_api === 'granted',
      advanced_matching: consent.advanced_matching === 'granted',
    }
  }

  function parseConsentCookie(raw) {
    if (!raw) return null
    try {
      return JSON.parse(raw)
    } catch {
      return null
    }
  }

  function phoneToE164(raw, defaultCountry = '+48') {
    if (!raw) return undefined
    const normalized = raw.replace(/[^\d+]/g, '')
    if (!normalized) return undefined
    if (normalized.startsWith('+')) return normalized
    if (normalized.startsWith('00')) return `+${normalized.slice(2)}`
    return `${defaultCountry}${normalized}`
  }

  function loadAnalyticsUser() {
    try {
      const raw = localStorage.getItem('analytics_user')
      return raw ? JSON.parse(raw) : null
    } catch {
      return null
    }
  }

  function buildAdvancedMatching(selection) {
    if (!selection.advanced_matching) return null
    const user = loadAnalyticsUser()
    if (!user) return null

    const payload = {}
    if (user.email) payload.em = user.email.trim().toLowerCase()
    if (user.phone) {
      const phone = phoneToE164(user.phone)
      if (phone) payload.ph = phone
    }
    if (user.first_name) payload.fn = user.first_name.trim().toLowerCase()
    if (user.last_name) payload.ln = user.last_name.trim().toLowerCase()
    if (user.city) payload.ct = user.city.trim().toLowerCase()
    if (user.postal_code) payload.zp = user.postal_code.trim().toLowerCase()
    if (user.country_code) payload.country = user.country_code.trim().toLowerCase()
    if (user.external_id) payload.external_id = user.external_id.toString().trim()

    return Object.keys(payload).length ? payload : null
  }

  // Meta Pixel functions
  function bootstrapMetaPixel() {
    if (typeof window.fbq === 'function') return

    const fbq = function() {
      fbq.queue.push(arguments)
    }
    fbq.push = function() {
      fbq.queue.push(arguments)
    }
    fbq.queue = []
    fbq.loaded = true
    fbq.version = '2.0'

    window.fbq = fbq
    window._fbq = fbq
  }

  function loadMetaPixelScript() {
    if (metaPixelScriptPromise) return metaPixelScriptPromise

    metaPixelScriptPromise = new Promise((resolve) => {
      const existing = document.getElementById('meta-pixel-script')
      if (existing) {
        if (existing._loaded) {
          resolve()
          return
        }
        existing.addEventListener('load', () => {
          existing._loaded = true
          resolve()
        }, { once: true })
        existing.addEventListener('error', () => resolve(), { once: true })
        return
      }

      const script = document.createElement('script')
      script.id = 'meta-pixel-script'
      script.async = true
      script.src = 'https://connect.facebook.net/en_US/fbevents.js'
      script.onload = () => {
        script._loaded = true
        resolve()
      }
      script.onerror = () => resolve()
      document.head.appendChild(script)
    })

    return metaPixelScriptPromise
  }

  async function ensureMetaPixel(pixelId, selection) {
    if (!pixelId) return

    bootstrapMetaPixel()
    const scriptPromise = loadMetaPixelScript()
    const advancedMatching = buildAdvancedMatching(selection)

    window.__metaPixelId = pixelId
    window.__metaPixelAdvancedMatching = Boolean(selection.advanced_matching)

    if (!loadedMetaPixels.has(pixelId)) {
      loadedMetaPixels.add(pixelId)
      window.fbq('set', 'autoConfig', false, pixelId)
      if (advancedMatching) {
        window.fbq('init', pixelId, advancedMatching)
      } else {
        window.fbq('init', pixelId)
      }
    } else if (advancedMatching) {
      window.fbq('init', pixelId, advancedMatching)
    }

    await scriptPromise
  }

  // Google Analytics functions
  function ensureGtagScript(primaryId) {
    if (!primaryId) return Promise.resolve()
    if (gtagScriptPromise) return gtagScriptPromise

    gtagScriptPromise = new Promise((resolve) => {
      const existing = document.querySelector('script[data-analytics="gtag"]')
      if (existing) {
        resolve()
        return
      }

      const script = document.createElement('script')
      script.async = true
      script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(primaryId)}`
      script.dataset.analytics = 'gtag'
      script.onload = () => {
        window.gtag('js', new Date())
        resolve()
      }
      script.onerror = () => resolve()
      document.head.appendChild(script)
    })

    return gtagScriptPromise
  }

  // Initialize tracking
  async function initializeTracking(selection) {
    // Meta Pixel
    if (META_PIXEL_ID) {
      if (selection.marketing) {
        await ensureMetaPixel(META_PIXEL_ID, selection)
        window.fbq && window.fbq('consent', 'grant')
      } else {
        window.fbq && window.fbq('consent', 'revoke')
      }
    }

    // GA4 - always load for Consent Mode v2 cookieless tracking
    if (GA4_ID) {
      await ensureGtagScript(GA4_ID)

      if (!configuredGtagIds.has(GA4_ID)) {
        if (selection.analytics) {
          // Full analytics mode with cookies
          window.gtag('config', GA4_ID, { send_page_view: false })
        } else {
          // Cookieless mode - restricted settings
          window.gtag('config', GA4_ID, {
            send_page_view: false,
            allow_google_signals: false,
            allow_ad_personalization_signals: false,
          })
        }
        configuredGtagIds.add(GA4_ID)
      }
    }
  }

  // Main consent handler
  async function handleConsentApply(selection) {
    const consentMode = toConsentMode(selection)
    window.gtag('consent', 'update', consentMode)
    setCookie(COOKIE_NAME, JSON.stringify(consentMode), resolveConsentTtl(selection))

    window.__metaPixelId = META_PIXEL_ID || null
    window.__metaPixelAdvancedMatching = selection.advanced_matching

    setAnalyticsReady(false)
    try {
      await initializeTracking(selection)
    } finally {
      setAnalyticsReady(true)
      document.dispatchEvent(new CustomEvent('cookie_consent_updated', { detail: consentMode }))
    }

    const focusedElement = document.activeElement
    if (focusedElement && cookieConsentElement.contains(focusedElement)) {
      focusedElement.blur()
    }
    cookieConsentElement.setAttribute('aria-hidden', 'true')
  }

  // Initialize dataLayer and gtag
  window.dataLayer = window.dataLayer || []
  window.gtag = function gtag() {
    window.dataLayer.push(arguments)
  }

  // Set initial analytics ready state
  window.__analyticsReady = false

  // Check for existing consent
  const storedConsentRaw = getCookie(COOKIE_NAME)
  const storedConsent = parseConsentCookie(storedConsentRaw)

  if (!storedConsent) {
    // No consent decision yet - set default denied
    window.gtag('consent', 'default', DENIED_CONSENT_MODE)
  } else {
    // Has consent - set stored values as default
    window.gtag('consent', 'default', storedConsent)
  }

  // DOM elements
  const cookieConsentElement = document.querySelector('.cookie-consent')
  const acceptAllButton = cookieConsentElement.querySelector('.agree')
  const preferencesButton = cookieConsentElement.querySelector('.setPreferences')
  const denyButton = cookieConsentElement.querySelector('.deny')
  let isPreferencesOpen = false

  // Show banner or initialize tracking based on consent state
  if (!storedConsent) {
    cookieConsentElement.setAttribute('aria-hidden', 'false')
  } else {
    // Initialize tracking with stored consent
    const selection = selectionFromConsent(storedConsent)
    ;(async () => {
      setAnalyticsReady(false)
      try {
        await initializeTracking(selection)
      } finally {
        setAnalyticsReady(true)
      }
    })()
  }

  // Event listeners
  acceptAllButton.addEventListener('click', () => {
    handleConsentApply({
      necessary: true,
      marketing: true,
      analytics: true,
      preferences: true,
      conversion_api: true,
      advanced_matching: true,
    })
  })

  preferencesButton.addEventListener('click', () => {
    if (!isPreferencesOpen) {
      cookieConsentElement.querySelector('.header [data-header-initial]').style.display = 'none'
      cookieConsentElement.querySelector('.header [data-header-settings]').style.removeProperty('display')
      cookieConsentElement.querySelector('.settings').style.removeProperty('display')
      isPreferencesOpen = true
    } else {
      handleConsentApply({
        necessary: cookieConsentElement.querySelector('input[id="necessary"]').checked,
        marketing: cookieConsentElement.querySelector('input[id="marketing"]').checked,
        analytics: cookieConsentElement.querySelector('input[id="analytics"]').checked,
        preferences: cookieConsentElement.querySelector('input[id="preferences"]').checked,
        conversion_api: cookieConsentElement.querySelector('input[id="conversion_api"]').checked,
        advanced_matching: cookieConsentElement.querySelector('input[id="advanced_matching"]').checked,
      })
    }
  })

  denyButton.addEventListener('click', () => {
    handleConsentApply({
      necessary: false,
      marketing: false,
      analytics: false,
      preferences: false,
      conversion_api: false,
      advanced_matching: false,
    })
  })

  // Marketing switch controls sub-switches
  const marketingSwitch = cookieConsentElement.querySelector('input[id="marketing"]')
  const subSwitches = cookieConsentElement.querySelectorAll('.sub-groups input[type="checkbox"]')
  let isMarketingSwitchTriggered = false

  marketingSwitch.addEventListener('change', (e) => {
    isMarketingSwitchTriggered = true
    subSwitches.forEach((subSwitch) => {
      subSwitch.checked = e.target.checked
    })
    isMarketingSwitchTriggered = false
  })

  subSwitches.forEach((subSwitch) => {
    subSwitch.addEventListener('change', (e) => {
      if (!isMarketingSwitchTriggered && e.target.checked) {
        marketingSwitch.checked = true
      }
    })
  })

  // Reset consent button handler
  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('reset-cookie-consent')?.addEventListener('click', () => {
      document.cookie = `${COOKIE_NAME}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`
      window.gtag('consent', 'default', DENIED_CONSENT_MODE)
      window.fbq && window.fbq('consent', 'revoke')
      window.__metaPixelId = META_PIXEL_ID || null
      window.__metaPixelAdvancedMatching = false
      window.__analyticsReady = false
      configuredGtagIds.clear()
      cookieConsentElement.setAttribute('aria-hidden', 'false')
      // Reset preferences view
      cookieConsentElement.querySelector('.header [data-header-initial]').style.removeProperty('display')
      cookieConsentElement.querySelector('.header [data-header-settings]').style.display = 'none'
      cookieConsentElement.querySelector('.settings').style.display = 'none'
      isPreferencesOpen = false
      // Reset all checkboxes
      cookieConsentElement.querySelectorAll('input[type="checkbox"]:not([id="necessary"])').forEach((cb) => {
        cb.checked = false
      })
    })
  })

  // Listen for analytics user updates to refresh Meta Pixel advanced matching
  document.addEventListener('analytics_user_updated', () => {
    const consent = parseConsentCookie(getCookie(COOKIE_NAME))
    if (consent && META_PIXEL_ID) {
      const selection = selectionFromConsent(consent)
      if (selection.advanced_matching) {
        ensureMetaPixel(META_PIXEL_ID, selection)
      }
    }
  })
</script>
